{% extends "base.html" %}
{% block title %}{{ post.title }} – Blog{% endblock %}

<!-- [ZMIANA] Usunięto cały blok head i style, wszystko jest teraz w style.css -->
{% block head %}{% endblock %}

{% block content %}
<div class="container my-3 blog-article-page">
  <div class="row justify-content-center">
    <div class="col-lg-9 col-xl-8">
      <article class="blog-article">
        <header>
          <div class="blog-article-meta">
            {% if post.category %}
              <span class="blog-article-meta-pill">{{ post.category.name }}</span>
            {% endif %}
            <span>
              {% if post.published_at %}
                {{ post.published_at.strftime('%d.%m.%Y') }}
              {% elif post.created_at %}
                {{ post.created_at.strftime('%d.%m.%Y') }}
              {% endif %}
            </span>
            {% if post.read_time %}
              <span>· {{ post.read_time }} min czytania</span>
            {% endif %}
          </div>

          <h1 class="blog-article-title">{{ post.title }}</h1>

          {% if post.subtitle %}
            <div class="blog-article-sub">{{ post.subtitle }}</div>
          {% endif %}

          <div class="blog-article-author">
            <div class="avatar"></div>
            <div>
              <div>
                {% if post.author and (post.author.username or post.author.email) %} <!-- [ZMIANA] Sprawdzenie username -->
                  {{ post.author.username or post.author.email }}
                {% else %}
                  Redakcja Bimberek
                {% endif %}
              </div>
              <div style="font-size:.78rem;">Artykuł na blogu Bimberek Białostocki</div>
            </div>
          </div>
        </header>

        {% if post.cover_image %}
        <div class="blog-article-cover">
          <!-- [ZMIANA] Dodano alt text -->
          <img src="{{ url_for('static', filename='images/blog/' ~ post.cover_image) }}" alt="{{ post.title }}">
        </div>
        {% endif %}

        <div class="blog-article-body">
          {% if post.content_html %} <!-- [ZMIANA] Użycie content_html -->
            {{ post.content_html|safe }}
          {% else %}
            <!-- Fallback dla starych postów -->
            {{ post.content|safe }}
          {% endif %}
        </div>

        {% if post.tags %}
        <div class="blog-tags">
          {% for t in post.tags %}
            <span class="blog-tag">
              {% if t.name is defined %}{{ t.name }}{% else %}{{ t }}{% endif %}
            </span>
          {% endfor %}
        </div>
        {% endif %}

        <div class="blog-nav">
          <div>
            {% if prev_post %}
              <div class="muted mb-1">Poprzedni wpis</div> <!-- [ZMIANA] Użycie klasy muted -->
              <a href="{{ url_for('blog.post_detail', post_id=prev_post.id) }}">
                ‹ {{ prev_post.title }}
              </a>
            {% endif %}
          </div>
          <div class="text-end">
            {% if next_post %}
              <div class="muted mb-1">Następny wpis</div> <!-- [ZMIANA] Użycie klasy muted -->
              <a href="{{ url_for('blog.post_detail', post_id=next_post.id) }}">
                {{ next_post.title }} ›
              </a>
            {% endif %}
          </div>
        </div>
      </article>

      <!-- [ZMIANA] Dodanie sekcji komentarzy (jeśli istnieje formularz) -->
      {% if form is defined %}
      <div class="section-card section-pad mt-4">
        <h2 class="h5">Komentarze</h2>
        <form method="post" action="{{ url_for('blog.post_detail', post_id=post.id) }}">
          {{ form.hidden_tag() }}
          <div class="mb-2">
            {{ form.content.label(class="form-label") }}
            {{ form.content(class="form-control", rows=4) }}
            {% for e in form.content.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm">
            Dodaj komentarz
          </button>
          {% if not current_user.is_authenticated %}
          <p class="small muted mt-1 mb-0">
            Musisz być <a href="{{ url_for('auth.login', next=request.url) }}">zalogowany</a>, aby dodać komentarz.
          </p>
          {% endif %}
        </form>

        {% if comments %}
          <hr style="border-color: rgba(148,163,184,.25);" class="my-3">
          <div class="d-flex flex-column gap-3">
            {% for c in comments %}
            <div class="d-flex gap-2">
              <div class="avatar" style="width: 30px; height: 30px; border-radius: 50%; background: radial-gradient(circle at 30% 0%,#f97316,#ea580c); flex-shrink: 0;"></div>
              <div>
                <div class="small">
                  <span class="fw-semibold">{{ c.user.username or c.user.email or 'Użytkownik' }}</span>
                  <span class="muted ms-1">
                    {% if c.created_at %}
                      • {{ c.created_at.strftime('%Y-%m-%d') }}
                    {% endif %}
                  </span>
                </div>
                <div class="blog-article-body p-0" style="font-size: 0.95rem;">
                  {{ c.content|safe }}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted small mb-0 mt-2">Brak komentarzy.</p>
        {% endif %}
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}