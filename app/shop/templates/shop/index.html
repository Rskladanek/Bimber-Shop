{% extends "base.html" %}
{% block title %}Sklep{% endblock %}

<!-- Style są w /static/css/style.css, ten blok nie jest już potrzebny -->
{% block head %}{% endblock %}

{% block content %}
<div class="container my-3">

  <div class="row g-3">
    <!-- LEWA: SLIDER -->
    <div class="col-lg-9">
      {% set slides = (active_slider.items if active_slider and active_slider.items else []) %}
      {% if slides %}
      <div class="slider-wrap section-card">
        <div class="section-pad muted">Polecane</div>
        <div id="sliderTrack" class="slider-track">
          {% for it in slides %}
            {% set p = it.product %}
            <div class="slide">
              <div class="slide-card section-card">
                {% if p and p.image_filename %}
                  <!-- [ZMIANA] Dodano alt text dla dostępności -->
                  <img class="slide-img" src="{{ url_for('static', filename='images/products/' ~ p.image_filename) }}" alt="{{ p.name }}">
                {% else %}
                  <img class="slide-img" src="https://placehold.co/1600x900/020617/374151?text=Bimberek" alt="Domyślny obrazek">
                {% endif %}
                <div class="slide-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="fw-semibold">{{ p.name if p else 'Produkt' }}</div>
                    {% if p %}<div class="price">{{ '%.2f'|format(p.price) }} PLN</div>{% endif %}
                  </div>
                  {% if p and p.description_html %}
                    <div class="muted small">{{ p.description_html|striptags|truncate(120) }}</div>
                  {% endif %}
                  {% if p %}
                  <div class="mt-2 d-flex gap-2">
                    <a class="btn btn-primary btn-sm" href="{{ url_for('shop.product_detail', product_id=p.id) }}">Zobacz</a>
                    <form method="post" action="{{ url_for('shop.add_to_cart', product_id=p.id) }}">
                      {{ csrf_token() if csrf_token is defined else '' }}
                      <input type="hidden" name="quantity" value="1">
                      <button class="btn btn-outline-light btn-sm" {% if p.stock is not none and p.stock<=0 %}disabled{% endif %}>Do koszyka</button>
                    </form>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
        <div class="slider-nav">
          <button class="slider-btn" id="prevSlide" aria-label="Prev"><i class="bi bi-chevron-left"></i></button>
          <button class="slider-btn" id="nextSlide" aria-label="Next"><i class="bi bi-chevron-right"></i></button>
        </div>
      </div>
      {% else %}
        <div class="section-card section-pad muted">Brak aktywnego slidera – dodaj w panelu admina.</div>
      {% endif %}
    </div>

    <!-- PRAWA: KATEGORIE + SZUKAJKA -->
    <div class="col-lg-3">
      <div class="sidebar">
        <div class="section-card section-pad">
          <form method="get" action="{{ url_for('shop.index') }}" class="mb-2">
            {% if current_category_id %}<input type="hidden" name="cat" value="{{ current_category_id }}">{% endif %}
            <div class="input-group input-group-sm">
              <input type="search" name="q" value="{{ q or '' }}" class="form-control" placeholder="Szukaj produktu...">
              <button class="btn btn-primary"><i class="bi bi-search"></i></button>
            </div>
          </form>
          <div class="muted small mb-2">Kategorie</div>
          <ul class="cat-list">
            <li>
              <a class="cat-link {% if not current_category_id %}active{% endif %}" href="{{ url_for('shop.index') }}">
                <span>Wszystkie</span>
              </a>
            </li>
            {% for c in categories %}
            <li>
              <a class="cat-link {% if current_category_id==c.id %}active{% endif %}"
                 href="{{ url_for('shop.index', cat=c.id, q=q) }}">
                <span>{{ c.name }}</span>
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- GRID PRODUKTÓW -->
  <div class="section-card section-pad mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">
        {% if current_category_id %}
          {{ categories|selectattr('id','equalto',current_category_id)|map(attribute='name')|list|first or 'Kategoria' }}
        {% else %}
          Wszystkie produkty
        {% endif %}
        {% if q %}<span class="muted">– szukaj: „{{ q }}”</span>{% endif %}
      </div>
      {% if q or current_category_id %}
        <a class="btn btn-outline-light btn-sm" href="{{ url_for('shop.index') }}">Wyczyść filtr</a>
      {% endif %}
    </div>

    {% if products and products.items|length %}
      <div class="grid">
        {% for p in products.items %}
          <div class="prod-card section-card">
            {% if p.image_filename %}
              <!-- [ZMIANA] Dodano alt text dla dostępności -->
              <img class="prod-img" src="{{ url_for('static', filename='images/products/' ~ p.image_filename) }}" alt="{{ p.name }}">
            {% else %}
              <img class="prod-img" src="https://placehold.co/600x600/020617/374151?text=Bimberek" alt="Domyślny obrazek">
            {% endif %}
            <div class="prod-body">
              <div class="fw-semibold">{{ p.name }}</div>
              <div class="d-flex justify-content-between">
                <div class="price">{{ '%.2f'|format(p.price) }} PLN</div>
                {% if p.stock is not none %}
                  {% if p.stock<=0 %}
                    <span class="stock-zero small">Brak</span>
                  {% elif p.stock<5 %}
                    <span class="stock-low small">Mało ({{ p.stock }})</span>
                  {% else %}
                    <span class="stock-ok small">{{ p.stock }} szt.</span>
                  {% endif %}
                {% endif %}
              </div>
              <div class="d-flex gap-2 mt-auto pt-2"> <!-- [ZMIANA] mt-auto aby przyciski były na dole -->
                <a class="btn btn-outline-light btn-sm" href="{{ url_for('shop.product_detail', product_id=p.id) }}">Szczegóły</a>
                <form method="post" action="{{ url_for('shop.add_to_cart', product_id=p.id) }}">
                  {{ csrf_token() if csrf_token is defined else '' }}
                  <input type="hidden" name="quantity" value="1">
                  <button class="btn btn-primary btn-sm" {% if p.stock is not none and p.stock<=0 %}disabled{% endif %}>
                    <i class="bi bi-bag-plus"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Paginacja -->
      {% if products.pages > 1 %}
      <nav class="mt-3 d-flex justify-content-center"> <!-- [ZMIANA] Wyśrodkowanie paginacji -->
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item {% if not products.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('shop.index', cat=current_category_id, q=q, page=products.prev_num) }}">«</a>
          </li>
          {% for p_num in products.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p_num %}
              <li class="page-item {% if p_num == products.page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('shop.index', cat=current_category_id, q=q, page=p_num) }}">{{ p_num }}</a>
              </li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}
          <li class="page-item {% if not products.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('shop.index', cat=current_category_id, q=q, page=products.next_num) }}">»</a>
          </li>
        </ul>
      </nav>
      {% endif %}

    {% else %}
      <div class="alert alert-secondary mb-0">
        Nic nie znaleziono. Zmień kategorię lub wyszukaj inaczej.
      </div>
    {% endif %}
  </div>
</div>

<!-- [ZMIANA] Skrypt wraca na swoje pierwotne miejsce, czyli do bloku 'content' -->
<script>
  (function(){
    const track = document.getElementById('sliderTrack');
    if (!track) return;

    // Funkcja obliczająca krok przesunięcia
    const getStep = () => {
      const s = track.querySelector('.slide');
      return s ? s.getBoundingClientRect().width : track.clientWidth; // Użyj szerokości slajdu
    };

    let currentScroll = 0;
    const trackWidth = track.scrollWidth;
    const containerWidth = track.clientWidth;

    const next = () => {
      const step = getStep();
      currentScroll += step;
      // Proste zapętlenie slidera
      if (currentScroll >= (trackWidth - containerWidth + 1)) { // +1 dla precyzji float
          track.scrollTo({ left: 0, behavior: 'smooth' });
          currentScroll = 0;
      } else {
          track.scrollBy({ left: step, behavior: 'smooth' });
      }
    };

    const prev = () => {
      const step = getStep();
      currentScroll -= step;
      // Zapętlenie do tyłu
      if (currentScroll < 0) {
          const newPos = trackWidth - containerWidth;
          track.scrollTo({ left: newPos, behavior: 'smooth' });
          currentScroll = newPos;
      } else {
          track.scrollBy({ left: -step, behavior: 'smooth' });
      }
    };

    document.getElementById('nextSlide')?.addEventListener('click', next);
    document.getElementById('prevSlide')?.addEventListener('click', prev);

    // Autoplay
    let autoPlayInterval = setInterval(next, 4000);
    
    // Pauza na hover
    const sliderWrap = track.closest('.slider-wrap');
    if (sliderWrap) {
        sliderWrap.addEventListener('mouseenter', () => clearInterval(autoPlayInterval));
        sliderWrap.addEventListener('mouseleave', () => autoPlayInterval = setInterval(next, 4000));
    }
  })();
</script>

<!-- [ZMIANA] To jest teraz JEDYNY endblock na końcu pliku, zamykający 'content' -->
{% endblock %}
