{% extends "base.html" %}
{% block title %}Blog{% endblock %}

<!-- [ZMIANA] Usunięto cały blok head i style, wszystko jest teraz w style.css -->
{% block head %}{% endblock %}

{% block content %}
<div class="container my-3 blog-page">
  <div class="row g-3">
    <!-- LEWA KOLUMNA: HERO + LISTA POSTÓW -->
    <div class="col-lg-8">
      <section class="blog-hero">
        <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center">
          <div>
            <div class="blog-hero-title">Blog</div>
            <div class="blog-hero-sub">
              Aktualności, poradniki i historie związane z Bimberek Białostocki.
            </div>
          </div>
          <div class="d-flex flex-column align-items-end gap-1">
            <span class="blog-chip">
              <i class="bi bi-journal-text"></i>
              {{ posts.total if posts is defined and posts.total is defined else (posts.items|length if posts and posts.items is defined else 0) }} wpisów
            </span>
            {% if q %}
              <span class="text-muted-soft">Filtr: „{{ q }}”</span>
            {% endif %}
          </div>
        </div>
      </section>

      {% if posts and posts.items|length %}
        <div class="blog-list">
          {% for post in posts.items %}
          <article class="blog-card">
            <a class="blog-thumb" href="{{ url_for('blog.post_detail', post_id=post.id) }}">
              {% if post.cover_image %}
                <!-- [ZMIANA] Dodano alt text -->
                <img src="{{ url_for('static', filename='images/blog/' ~ post.cover_image) }}" alt="{{ post.title }}">
              {% else %}
                <!-- [ZMIANA] Użycie placehold.co -->
                <img src="https://placehold.co/400x300/020617/374151?text=Bimberek" alt="Domyślny obrazek wpisu">
              {% endif %}
            </a>
            <div class="blog-card-body">
              <div class="blog-meta">
                {% if post.category %}
                  <span class="blog-meta-pill">{{ post.category.name }}</span>
                {% endif %}
                <span>
                  {% if post.published_at %}
                    {{ post.published_at.strftime('%d.%m.%Y') }}
                  {% elif post.created_at %}
                    {{ post.created_at.strftime('%d.%m.%Y') }}
                  {% endif %}
                </span>
                {% if post.read_time %}
                  <span>· {{ post.read_time }} min czytania</span>
                {% endif %}
              </div>
              <h2 class="blog-title">
                <a href="{{ url_for('blog.post_detail', post_id=post.id) }}">{{ post.title }}</a>
              </h2>
              {% if post.subtitle %}
                <p class="blog-excerpt">{{ post.subtitle }}</p>
              {% elif post.content_html %} <!-- [ZMIANA] Użycie content_html dla auto-skrótu -->
                <p class="blog-excerpt">
                  {{ post.content_html|striptags|truncate(180) }}
                </p>
              {% endif %}
              <div class="blog-footer">
                <div class="blog-author">
                  <div class="blog-author-avatar"></div>
                  <span>
                    {% if post.author and (post.author.username or post.author.email) %} <!-- [ZMIANA] Sprawdzenie username -->
                      {{ post.author.username or post.author.email }}
                    {% else %}
                      Redakcja
                    {% endif %}
                  </span>
                </div>
                <a class="btn btn-sm btn-outline-light" href="{{ url_for('blog.post_detail', post_id=post.id) }}">
                  Czytaj
                </a>
              </div>
            </div>
          </article>
          {% endfor %}
        </div>

        <!-- [ZMIANA] Paginacja wyśrodkowana i z kropkami -->
        {% if posts.pages > 1 %}
        <nav class="mt-3 d-flex justify-content-center">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item {% if not posts.has_prev %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('blog.post_list', page=posts.prev_num, cat=current_category_id, q=q) }}">«</a>
            </li>
            {% for p_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
              {% if p_num %}
                <li class="page-item {% if p_num == posts.page %}active{% endif %}">
                  <a class="page-link" href="{{ url_for('blog.post_list', page=p_num, cat=current_category_id, q=q) }}">{{ p_num }}</a>
                </li>
              {% else %}
                <li class="page-item disabled"><span class="page-link">…</span></li>
              {% endif %}
            {% endfor %}
            <li class="page-item {% if not posts.has_next %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('blog.post_list', page=posts.next_num, cat=current_category_id, q=q) }}">»</a>
            </li>
          </ul>
        </nav>
        {% endif %}

      {% else %}
        <div class="section-card section-pad text-center mt-3"> <!-- [ZMIANA] Użycie section-card -->
          <h2 class="h5">Na razie brak wpisów.</h2>
          <p class="muted">Dodaj coś w panelu admina lub poczekaj na moderację.</p>
        </div>
      {% endif %}
    </div>

    <!-- PRAWA KOLUMNA: SIDEBAR -->
    <div class="col-lg-4">
      <aside class="blog-sidebar">
        <!-- Szukajka -->
        <div class="blog-side-card">
          <div class="blog-side-title">Szukaj</div>
          <form method="get" action="{{ url_for('blog.post_list') }}">
            {% if current_category_id %}
              <input type="hidden" name="cat" value="{{ current_category_id }}">
            {% endif %}
            <div class="input-group input-group-sm">
              <input type="search"
                     name="q"
                     value="{{ q or '' }}"
                     class="form-control"
                     placeholder="Wpisz tytuł, tag, treść...">
              <button class="btn btn-primary">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </form>
        </div>

        <!-- Kategorie -->
        <div class="blog-side-card">
          <div class="blog-side-title">Kategorie</div>
          <ul class="blog-cat-list">
            <li>
              <a class="blog-cat-link {% if not current_category_id %}active{% endif %}"
                 href="{{ url_for('blog.post_list', q=q) }}">
                <span>Wszystko</span>
                {% if posts is defined and posts.total is defined %}
                  <span>{{ posts.total }}</span>
                {% endif %}
              </a>
            </li>
            {% if categories %}
              {% for c in categories %}
              <li>
                <a class="blog-cat-link {% if current_category_id==c.id %}active{% endif %}"
                   href="{{ url_for('blog.post_list', cat=c.id, q=q) }}">
                  <span>{{ c.name }}</span>
                  {% if c.posts_count is defined %} <!-- Zakładając, że model to zlicza -->
                    <span>{{ c.posts_count }}</span>
                  {% endif %}
                </a>
              </li>
              {% endfor %}
            {% else %}
              <li class="text-muted-soft">Brak kategorii.</li>
            {% endif %}
          </ul>
        </div>

        <!-- Ostatnie wpisy -->
        {% if recent_posts %}
        <div class="blog-side-card">
          <div class="blog-side-title">Ostatnie wpisy</div>
          <ul class="blog-recent-list">
            {% for p in recent_posts %}
            <li class="blog-recent-item">
              <a href="{{ url_for('blog.post_detail', post_id=p.id) }}">{{ p.title }}</a>
              <div class="blog-recent-meta">
                {% if p.published_at %}
                  {{ p.published_at.strftime('%d.%m.%Y') }}
                {% elif p.created_at %}
                  {{ p.created_at.strftime('%d.%m.%Y') }}
                {% endif %}
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- [ZMIANA] Dodano przycisk do tworzenia posta -->
        <div class="blog-side-card d-grid">
           <a href="{{ url_for('blog.new_post') }}" class="btn btn-primary">
             <i class="bi bi-pencil-square me-1"></i> Napisz nowy wpis
           </a>
        </div>
      </aside>
    </div>
  </div>
</div>
{% endblock %}